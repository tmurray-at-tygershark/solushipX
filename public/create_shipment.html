<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SoluShipX - Create Shipment</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #0d6efd;
      --secondary-color: #6c757d;
    }
    
    [data-bs-theme="dark"] {
      --bs-body-bg: #212529;
      --bs-body-color: #dee2e6;
    }

    body {
      padding: 20px;
      transition: background-color 0.3s ease;
    }

    .form-section {
      background: var(--bs-body-bg);
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      margin-bottom: 25px;
      border: 1px solid var(--bs-border-color);
      transition: all 0.3s ease;
    }

    .form-section:hover {
      box-shadow: 0 0 20px rgba(0,0,0,0.15);
    }

    .hidden {
      display: none;
    }

    input[type="date"],
    input[type="time"] {
      cursor: pointer;
    }

    .form-control, .form-select {
      border-radius: 6px;
      padding: 0.6rem 0.75rem;
      transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .theme-toggle {
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--bs-border-color);
      background: transparent;
      color: var(--bs-body-color);
    }

    .package-card {
      border: 1px solid var(--bs-border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: var(--bs-body-bg);
    }

    .btn-add-package {
      width: 100%;
      border: 2px dashed var(--bs-border-color);
      padding: 15px;
      background: transparent;
      color: var(--bs-body-color);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .btn-add-package:hover {
      background: rgba(13, 110, 253, 0.1);
      border-color: var(--primary-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="section-header">
      <h2 class="mb-0">Create Shipment</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="formHandler.loadDraft()">
          <i class="bi bi-folder-symlink"></i> Load Draft
        </button>
        <button class="theme-toggle" onclick="toggleTheme()">
          <i class="bi bi-moon-stars"></i>
        </button>
      </div>
    </div>

    <form id="shipmentForm" class="needs-validation" novalidate>
      <!-- Shipment Information Section -->
      <div class="form-section">
        <h4>Shipment Information</h4>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Shipment Type</label>
            <select class="form-select" id="shipmentType">
              <option value="courier" selected>Courier</option>
              <option value="freight">Freight</option>
              <option value="ltl">LTL (Less-Than-Truckload)</option>
              <option value="ftl">FTL (Full-Truckload)</option>
              <option value="rail">Rail</option>
              <option value="air">Air</option>
              <option value="ocean">Ocean</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Booking Reference Number</label>
            <input type="text" class="form-control" id="bookingReference" placeholder="e.g., TFM-0228" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Shipment Date</label>
            <input type="date" class="form-control" id="shipmentDate" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Earliest Pickup Time</label>
            <input type="time" class="form-control" id="earliestPickup" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Latest Pickup Time</label>
            <input type="time" class="form-control" id="latestPickup" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Earliest Delivery Time</label>
            <input type="time" class="form-control" id="earliestDelivery" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Latest Delivery Time</label>
            <input type="time" class="form-control" id="latestDelivery" required>
          </div>
        </div>
      </div>

      <!-- Ship From Section -->
      <div class="form-section">
        <h4>Ship From</h4>
        <div class="row g-3">
          <!-- Autocomplete Address -->
          <div class="col-md-12">
            <label class="form-label">Address (Autocomplete)</label>
            <input type="text" class="form-control" id="fromAddress" placeholder="Start typing address..." required>
          </div>
          <!-- Split Address into Lines -->
          <div class="col-md-6">
            <label class="form-label">Address Line 1 (Street)</label>
            <input type="text" class="form-control" id="fromAddressLine1" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Address Line 2</label>
            <input type="text" class="form-control" id="fromAddressLine2">
          </div>
          <div class="col-md-4">
            <label class="form-label">City</label>
            <input type="text" class="form-control" id="fromCity" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">State/Province</label>
            <select class="form-select" id="fromStateSelect"></select>
            <input type="text" class="form-control hidden" id="fromStateText">
          </div>
          <div class="col-md-4">
            <label class="form-label">Postal Code</label>
            <input type="text" class="form-control" id="fromPostal" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Country</label>
            <select class="form-select" id="fromCountry" required>
              <option value="CA" selected>Canada</option>
              <option value="US">United States</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Ship To Section -->
      <div class="form-section">
        <h4>Ship To</h4>
        <div class="row g-3">
          <!-- Autocomplete Address -->
          <div class="col-md-12">
            <label class="form-label">Address (Autocomplete)</label>
            <input type="text" class="form-control" id="toAddress" placeholder="Start typing address..." required>
          </div>
          <!-- Split Address into Lines -->
          <div class="col-md-6">
            <label class="form-label">Address Line 1 (Street)</label>
            <input type="text" class="form-control" id="toAddressLine1" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Address Line 2</label>
            <input type="text" class="form-control" id="toAddressLine2">
          </div>
          <div class="col-md-4">
            <label class="form-label">City</label>
            <input type="text" class="form-control" id="toCity" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">State/Province</label>
            <select class="form-select" id="toStateSelect"></select>
            <input type="text" class="form-control hidden" id="toStateText">
          </div>
          <div class="col-md-4">
            <label class="form-label">Postal Code</label>
            <input type="text" class="form-control" id="toPostal" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Country</label>
            <select class="form-select" id="toCountry" required>
              <option value="CA" selected>Canada</option>
              <option value="US">United States</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Package Management Section -->
      <div class="form-section" id="packagesSection">
        <div class="section-header">
          <h4 class="mb-0">Packages</h4>
          <span class="badge bg-primary" id="packageCount">0 packages</span>
        </div>
        
        <div id="packagesList">
          <!-- Package cards will be inserted here -->
        </div>

        <button type="button" class="btn-add-package mt-3" onclick="addPackage()">
          <i class="bi bi-plus-lg"></i> Add Package
        </button>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex justify-content-end gap-3 mb-5">
        <button type="button" class="btn btn-secondary" onclick="formHandler.saveAsDraft()">
          <i class="bi bi-save"></i> Save as Draft
        </button>
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-box-seam"></i> Create Shipment
        </button>
      </div>
    </form>
  </div>

  <!-- Google Places API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Custom JS -->
  <script src="js/packages.js"></script>
  <script src="js/form-handler.js"></script>
  <script>
    // Full list of U.S. states and Canadian provinces/territories
    const usStates = {
      "AL": "Alabama", "AK": "Alaska", "AZ": "Arizona", "AR": "Arkansas", "CA": "California",
      "CO": "Colorado", "CT": "Connecticut", "DE": "Delaware", "FL": "Florida", "GA": "Georgia",
      "HI": "Hawaii", "ID": "Idaho", "IL": "Illinois", "IN": "Indiana", "IA": "Iowa",
      "KS": "Kansas", "KY": "Kentucky", "LA": "Louisiana", "ME": "Maine", "MD": "Maryland",
      "MA": "Massachusetts", "MI": "Michigan", "MN": "Minnesota", "MS": "Mississippi", "MO": "Missouri",
      "MT": "Montana", "NE": "Nebraska", "NV": "Nevada", "NH": "New Hampshire", "NJ": "New Jersey",
      "NM": "New Mexico", "NY": "New York", "NC": "North Carolina", "ND": "North Dakota", "OH": "Ohio",
      "OK": "Oklahoma", "OR": "Oregon", "PA": "Pennsylvania", "RI": "Rhode Island", "SC": "South Carolina",
      "SD": "South Dakota", "TN": "Tennessee", "TX": "Texas", "UT": "Utah", "VT": "Vermont",
      "VA": "Virginia", "WA": "Washington", "WV": "West Virginia", "WI": "Wisconsin", "WY": "Wyoming",
      "DC": "District of Columbia"
    };

    const canadaProvinces = {
      "AB": "Alberta", "BC": "British Columbia", "MB": "Manitoba", "NB": "New Brunswick",
      "NL": "Newfoundland and Labrador", "NS": "Nova Scotia", "NT": "Northwest Territories",
      "NU": "Nunavut", "ON": "Ontario", "PE": "Prince Edward Island", "QC": "Quebec",
      "SK": "Saskatchewan", "YT": "Yukon"
    };

    function initAutocomplete() {
      setupAutocomplete("fromAddress", "from");
      setupAutocomplete("toAddress", "to");

      // Prepopulate defaults for Country and State/Province
      document.getElementById("fromCountry").value = "CA";
      document.getElementById("toCountry").value = "CA";
      updateStateField("from", "Ontario", "ON", "CA");
      updateStateField("to", "Ontario", "ON", "CA");

      // Listen for manual country changes
      document.getElementById("fromCountry").addEventListener("change", function () {
        if (this.value === "CA") {
          updateStateField("from", "Ontario", "ON", "CA");
        } else if (this.value === "US") {
          updateStateField("from", "", "", "US");
        } else {
          updateStateField("from", "", "", "");
        }
      });
      document.getElementById("toCountry").addEventListener("change", function () {
        if (this.value === "CA") {
          updateStateField("to", "Ontario", "ON", "CA");
        } else if (this.value === "US") {
          updateStateField("to", "", "", "US");
        } else {
          updateStateField("to", "", "", "");
        }
      });
    }

    // Initialize Google Places Autocomplete for an input field
    function setupAutocomplete(inputId, prefix) {
      let autocomplete = new google.maps.places.Autocomplete(document.getElementById(inputId), {
        types: ["geocode"]
      });
      autocomplete.addListener("place_changed", function () {
        fillAddressFields(autocomplete, prefix);
      });
    }

    // Extract address components and fill in the respective fields
    function fillAddressFields(autocomplete, prefix) {
      let place = autocomplete.getPlace();
      let components = place.address_components || [];
      let streetNumber = "", route = "", subpremise = "";
      let city = "", state = "", stateCode = "", postalCode = "", country = "", countryCode = "";

      components.forEach(component => {
        let type = component.types[0];
        switch (type) {
          case "street_number":
            streetNumber = component.long_name;
            break;
          case "route":
            route = component.long_name;
            break;
          case "subpremise":
            subpremise = component.long_name;
            break;
          case "locality":
            city = component.long_name;
            break;
          case "administrative_area_level_1":
            state = component.long_name;
            stateCode = component.short_name;
            break;
          case "postal_code":
            postalCode = component.long_name;
            break;
          case "country":
            country = component.long_name;
            countryCode = component.short_name;
            break;
        }
      });

      // Combine street number and route for Address Line 1
      const addressLine1 = (streetNumber + " " + route).trim();
      document.getElementById(`${prefix}AddressLine1`).value = addressLine1;
      document.getElementById(`${prefix}AddressLine2`).value = subpremise;
      document.getElementById(`${prefix}City`).value = city;
      document.getElementById(`${prefix}Postal`).value = postalCode;
      document.getElementById(`${prefix}Country`).value = country;

      updateStateField(prefix, state, stateCode, countryCode);
    }

    // Update state/province field based on the country code and extracted data
    function updateStateField(prefix, state, stateCode, countryCode) {
      const stateSelect = document.getElementById(`${prefix}StateSelect`);
      stateSelect.innerHTML = "";
      const statesList = countryCode === "US" ? usStates : countryCode === "CA" ? canadaProvinces : null;
      
      if (statesList) {
        for (let code in statesList) {
          let selected = code === stateCode ? "selected" : "";
          stateSelect.innerHTML += `<option value="${code}" ${selected}>${statesList[code]}</option>`;
        }
        stateSelect.classList.remove("hidden");
      } else {
        // If no list available, nothing to show in dropdown.
        // (Alternatively, you could show an input for manual entry.)
      }
    }

    window.onload = initAutocomplete;

    // Theme toggle functionality
    function toggleTheme() {
      const html = document.documentElement;
      const isDark = html.getAttribute('data-bs-theme') === 'dark';
      const newTheme = isDark ? 'light' : 'dark';
      html.setAttribute('data-bs-theme', newTheme);
      
      // Update toggle button icon
      const icon = document.querySelector('.theme-toggle i');
      icon.className = isDark ? 'bi bi-sun' : 'bi bi-moon-stars';
      
      // Save preference
      localStorage.setItem('theme', newTheme);
    }

    // Load saved theme preference
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-bs-theme', savedTheme);

    // Form submission handler
    document.getElementById('shipmentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await formHandler.submitShipment();
    });
  </script>
</body>
</html>
