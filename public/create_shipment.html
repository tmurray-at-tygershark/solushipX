<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SoluShipX - Create Shipment</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #0d6efd;
      --secondary-color: #6c757d;
    }
    
    [data-bs-theme="dark"] {
      --bs-body-bg: #212529;
      --bs-body-color: #dee2e6;
    }

    body {
      padding: 20px;
      transition: background-color 0.3s ease;
    }

    .form-section {
      background: var(--bs-body-bg);
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      margin-bottom: 25px;
      border: 1px solid var(--bs-border-color);
      transition: all 0.3s ease;
    }

    .form-section:hover {
      box-shadow: 0 0 20px rgba(0,0,0,0.15);
    }

    .hidden {
      display: none;
    }

    input[type="date"],
    input[type="time"] {
      cursor: pointer;
    }

    .form-control, .form-select {
      border-radius: 6px;
      padding: 0.6rem 0.75rem;
      transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .theme-toggle {
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--bs-border-color);
      background: transparent;
      color: var(--bs-body-color);
    }

    .package-card {
      border: 1px solid var(--bs-border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: var(--bs-body-bg);
    }

    .btn-add-package {
      width: 100%;
      border: 2px dashed var(--bs-border-color);
      padding: 15px;
      background: transparent;
      color: var(--bs-body-color);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .btn-add-package:hover {
      background: rgba(13, 110, 253, 0.1);
      border-color: var(--primary-color);
    }

    .rate-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .rate-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .rate-card .card-header {
      border-bottom: 0;
    }

    .rate-card .card-body {
      padding: 1.25rem;
    }

    .rate-card .card-footer {
      background: transparent;
      border-top: 1px solid var(--bs-border-color);
      padding: 1rem;
    }

    .rate-card.saia-ltl-freight .card-header {
      background: #1a237e !important;
    }

    .rate-card.xpo-logistics .card-header {
      background: #d32f2f !important;
    }

    .rate-card.fedex-freight-priority .card-header {
      background: #4a148c !important;
    }

    .rate-card.fedex-freight-economy .card-header {
      background: #006064 !important;
    }

    .rate-card.dayton-freight .card-header {
      background: #1b5e20 !important;
    }

    .rate-card.averitt-express .card-header {
      background: #e65100 !important;
    }

    .form-control.is-valid,
    .form-select.is-valid {
        padding-right: calc(1.5em + 0.75rem) !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        border-color: #198754;
    }

    .form-control.is-invalid,
    .form-select.is-invalid {
        padding-right: calc(1.5em + 0.75rem) !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        border-color: #dc3545;
    }

    .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }

    .is-invalid ~ .invalid-feedback {
        display: block;
    }

    .valid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #198754;
    }

    .is-valid ~ .valid-feedback {
        display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="section-header">
      <h2 class="mb-0">Create Shipment</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="formHandler.loadDraft()">
          <i class="bi bi-folder-symlink"></i> Load Draft
        </button>
        <button class="theme-toggle" onclick="toggleTheme()">
          <i class="bi bi-moon-stars"></i>
        </button>
      </div>
    </div>

    <form id="shipmentForm" class="needs-validation" novalidate>
    <!-- Shipment Information Section -->
    <div class="form-section">
      <h4>Shipment Information</h4>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Shipment Type</label>
          <select class="form-select" id="shipmentType">
            <option value="courier" selected>Courier</option>
            <option value="freight">Freight</option>
            <option value="ltl">LTL (Less-Than-Truckload)</option>
            <option value="ftl">FTL (Full-Truckload)</option>
            <option value="rail">Rail</option>
            <option value="air">Air</option>
            <option value="ocean">Ocean</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Booking Reference Number</label>
          <input type="text" class="form-control" id="bookingReference" placeholder="e.g., TFM-0228" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Shipment Date</label>
          <input type="date" class="form-control" id="shipmentDate" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Earliest Pickup Time</label>
          <input type="time" class="form-control" id="earliestPickup" required step="3600">
        </div>
        <div class="col-md-4">
          <label class="form-label">Latest Pickup Time</label>
          <input type="time" class="form-control" id="latestPickup" required step="3600">
        </div>
        <div class="col-md-4">
          <label class="form-label">Earliest Delivery Time</label>
          <input type="time" class="form-control" id="earliestDelivery" required step="3600">
        </div>
        <div class="col-md-4">
          <label class="form-label">Latest Delivery Time</label>
          <input type="time" class="form-control" id="latestDelivery" required step="3600">
        </div>
      </div>
    </div>

    <!-- Ship From Section -->
    <div class="form-section">
      <h4>Ship From</h4>
      <div class="row g-3">
          <!-- Company and Contact Info -->
          <div class="col-md-6">
            <label class="form-label">Company Name</label>
            <input type="text" class="form-control" id="fromCompany" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Contact Name</label>
            <input type="text" class="form-control" id="fromContactName" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Phone</label>
            <input type="tel" class="form-control" id="fromPhone" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="fromEmail" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Fax</label>
            <input type="tel" class="form-control" id="fromFax">
          </div>
        <!-- Autocomplete Address -->
        <div class="col-md-12">
          <label class="form-label">Address (Autocomplete)</label>
            <input type="text" class="form-control" id="fromAddress" placeholder="Start typing address...">
        </div>
        <!-- Split Address into Lines -->
        <div class="col-md-6">
          <label class="form-label">Address Line 1 (Street)</label>
          <input type="text" class="form-control" id="fromAddressLine1" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Address Line 2</label>
          <input type="text" class="form-control" id="fromAddressLine2">
        </div>
        <div class="col-md-4">
          <label class="form-label">City</label>
          <input type="text" class="form-control" id="fromCity" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">State/Province</label>
          <select class="form-select" id="fromStateSelect"></select>
          <input type="text" class="form-control hidden" id="fromStateText">
        </div>
        <div class="col-md-4">
          <label class="form-label">Postal Code</label>
          <input type="text" class="form-control" id="fromPostal" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Country</label>
          <select class="form-select" id="fromCountry" required>
              <option value="CA" selected>Canada</option>
              <option value="US">United States</option>
            <option value="Other">Other</option>
          </select>
        </div>
          <div class="col-md-12">
            <label class="form-label">Special Instructions</label>
            <textarea class="form-control" id="fromInstructions" rows="2"></textarea>
          </div>
      </div>
    </div>

    <!-- Ship To Section -->
    <div class="form-section">
      <h4>Ship To</h4>
      <div class="row g-3">
          <!-- Company and Contact Info -->
          <div class="col-md-6">
            <label class="form-label">Company Name</label>
            <input type="text" class="form-control" id="toCompany" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Contact Name</label>
            <input type="text" class="form-control" id="toContactName" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Phone</label>
            <input type="tel" class="form-control" id="toPhone" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="toEmail" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Fax</label>
            <input type="tel" class="form-control" id="toFax">
          </div>
        <!-- Autocomplete Address -->
        <div class="col-md-12">
          <label class="form-label">Address (Autocomplete)</label>
            <input type="text" class="form-control" id="toAddress" placeholder="Start typing address...">
        </div>
        <!-- Split Address into Lines -->
        <div class="col-md-6">
          <label class="form-label">Address Line 1 (Street)</label>
          <input type="text" class="form-control" id="toAddressLine1" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Address Line 2</label>
          <input type="text" class="form-control" id="toAddressLine2">
        </div>
        <div class="col-md-4">
          <label class="form-label">City</label>
          <input type="text" class="form-control" id="toCity" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">State/Province</label>
          <select class="form-select" id="toStateSelect"></select>
          <input type="text" class="form-control hidden" id="toStateText">
        </div>
        <div class="col-md-4">
          <label class="form-label">Postal Code</label>
          <input type="text" class="form-control" id="toPostal" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Country</label>
          <select class="form-select" id="toCountry" required>
              <option value="CA" selected>Canada</option>
              <option value="US">United States</option>
            <option value="Other">Other</option>
          </select>
          </div>
          <div class="col-md-12">
            <label class="form-label">Special Instructions</label>
            <textarea class="form-control" id="toInstructions" rows="2"></textarea>
          </div>
        </div>
      </div>

      <!-- Packages Section -->
      <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">Packages</h4>
          <span class="badge bg-primary" id="packageCount">0 packages</span>
        </div>
        <div id="packagesList"></div>
        <button type="button" class="btn-add-package mt-3" onclick="addPackage()">
          <i class="bi bi-plus-lg"></i> Add Package
        </button>
      </div>

      <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
        <button type="button" class="btn btn-outline-primary" onclick="formHandler.saveAsDraft()">
          <i class="bi bi-save"></i> Save as Draft
        </button>
        <button type="submit" class="btn btn-primary" onclick="formHandler.calculateRates(event)">
          <i class="bi bi-calculator"></i> Calculate Rates
        </button>
      </div>
    </form>

    <!-- Rates Section -->
    <div id="ratesSection" class="form-section" style="display: none;">
      <h4>Available Rates</h4>
      <div id="ratesContainer" class="row"></div>
    </div>
  </div>

  <!-- Google Places API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Custom Scripts -->
  <script src="js/packages.js"></script>
  <script src="js/form-handler.js"></script>
  <script>
    // Full list of U.S. states and Canadian provinces/territories
    const usStates = {
      "AL": "Alabama", "AK": "Alaska", "AZ": "Arizona", "AR": "Arkansas", "CA": "California",
      "CO": "Colorado", "CT": "Connecticut", "DE": "Delaware", "FL": "Florida", "GA": "Georgia",
      "HI": "Hawaii", "ID": "Idaho", "IL": "Illinois", "IN": "Indiana", "IA": "Iowa",
      "KS": "Kansas", "KY": "Kentucky", "LA": "Louisiana", "ME": "Maine", "MD": "Maryland",
      "MA": "Massachusetts", "MI": "Michigan", "MN": "Minnesota", "MS": "Mississippi", "MO": "Missouri",
      "MT": "Montana", "NE": "Nebraska", "NV": "Nevada", "NH": "New Hampshire", "NJ": "New Jersey",
      "NM": "New Mexico", "NY": "New York", "NC": "North Carolina", "ND": "North Dakota", "OH": "Ohio",
      "OK": "Oklahoma", "OR": "Oregon", "PA": "Pennsylvania", "RI": "Rhode Island", "SC": "South Carolina",
      "SD": "South Dakota", "TN": "Tennessee", "TX": "Texas", "UT": "Utah", "VT": "Vermont",
      "VA": "Virginia", "WA": "Washington", "WV": "West Virginia", "WI": "Wisconsin", "WY": "Wyoming",
      "DC": "District of Columbia"
    };

    const canadaProvinces = {
      "AB": "Alberta", "BC": "British Columbia", "MB": "Manitoba", "NB": "New Brunswick",
      "NL": "Newfoundland and Labrador", "NS": "Nova Scotia", "NT": "Northwest Territories",
      "NU": "Nunavut", "ON": "Ontario", "PE": "Prince Edward Island", "QC": "Quebec",
      "SK": "Saskatchewan", "YT": "Yukon"
    };

    function initAutocomplete() {
      try {
        // Check if Google Maps API is loaded
        if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
          console.warn('Google Maps API not loaded. Autocomplete disabled.');
          return;
        }

      setupAutocomplete("fromAddress", "from");
      setupAutocomplete("toAddress", "to");

      // Prepopulate defaults for Country and State/Province
        document.getElementById("fromCountry").value = "CA";
        document.getElementById("toCountry").value = "CA";
      updateStateField("from", "Ontario", "ON", "CA");
      updateStateField("to", "Ontario", "ON", "CA");

      // Listen for manual country changes
      document.getElementById("fromCountry").addEventListener("change", function () {
          if (this.value === "CA") {
          updateStateField("from", "Ontario", "ON", "CA");
          } else if (this.value === "US") {
          updateStateField("from", "", "", "US");
        } else {
          updateStateField("from", "", "", "");
        }
      });
      document.getElementById("toCountry").addEventListener("change", function () {
          if (this.value === "CA") {
          updateStateField("to", "Ontario", "ON", "CA");
          } else if (this.value === "US") {
          updateStateField("to", "", "", "US");
        } else {
          updateStateField("to", "", "", "");
        }
      });
      } catch (error) {
        console.warn('Error initializing autocomplete:', error);
      }
    }

    // Initialize Google Places Autocomplete for an input field
    function setupAutocomplete(inputId, prefix) {
      try {
        const input = document.getElementById(inputId);
        if (!input) return;

        let autocomplete = new google.maps.places.Autocomplete(input, {
        types: ["geocode"]
      });
        
      autocomplete.addListener("place_changed", function () {
        fillAddressFields(autocomplete, prefix);
      });

        // Prevent form submission on enter key in autocomplete field
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
          }
        });
      } catch (error) {
        console.warn('Error setting up autocomplete for ' + inputId + ':', error);
      }
    }

    // Extract address components and fill in the respective fields
    function fillAddressFields(autocomplete, prefix) {
      try {
      let place = autocomplete.getPlace();
        if (!place || !place.address_components) {
          console.warn('No place details available');
          return;
        }

        let components = place.address_components;
      let streetNumber = "", route = "", subpremise = "";
      let city = "", state = "", stateCode = "", postalCode = "", country = "", countryCode = "";

      components.forEach(component => {
        let type = component.types[0];
        switch (type) {
          case "street_number":
            streetNumber = component.long_name;
            break;
          case "route":
            route = component.long_name;
            break;
          case "subpremise":
            subpremise = component.long_name;
            break;
          case "locality":
            city = component.long_name;
            break;
          case "administrative_area_level_1":
            state = component.long_name;
            stateCode = component.short_name;
            break;
          case "postal_code":
            postalCode = component.long_name;
            break;
          case "country":
            country = component.long_name;
            countryCode = component.short_name;
            break;
        }
      });

      // Combine street number and route for Address Line 1
      const addressLine1 = (streetNumber + " " + route).trim();
        
        // Safely set field values
        const setFieldValue = (fieldId, value) => {
          const field = document.getElementById(fieldId);
          if (field) field.value = value;
        };

        setFieldValue(`${prefix}AddressLine1`, addressLine1);
        setFieldValue(`${prefix}AddressLine2`, subpremise);
        setFieldValue(`${prefix}City`, city);
        setFieldValue(`${prefix}Postal`, postalCode);
        setFieldValue(`${prefix}Country`, countryCode);

      updateStateField(prefix, state, stateCode, countryCode);
      } catch (error) {
        console.warn('Error filling address fields:', error);
      }
    }

    // Update state/province field based on the country code and extracted data
    function updateStateField(prefix, state, stateCode, countryCode) {
      const stateSelect = document.getElementById(`${prefix}StateSelect`);
      const stateText = document.getElementById(`${prefix}StateText`);
      
      // Clear existing options
      stateSelect.innerHTML = "";
      
      // Get the appropriate list of states/provinces
      const statesList = countryCode === "US" ? usStates : 
                        countryCode === "CA" ? canadaProvinces : null;
      
      if (statesList) {
        // Show select, hide text input
        stateSelect.classList.remove("hidden");
        stateText.classList.add("hidden");
        
        // Add default option
        stateSelect.innerHTML = `<option value="">Select ${countryCode === "US" ? "State" : "Province"}</option>`;
        
        // Add all states/provinces
        for (let code in statesList) {
          const option = document.createElement("option");
          option.value = code;
          option.textContent = statesList[code];
          if (code === stateCode || statesList[code] === state) {
            option.selected = true;
          }
          stateSelect.appendChild(option);
        }
      } else {
        // For other countries, show text input, hide select
        stateSelect.classList.add("hidden");
        stateText.classList.remove("hidden");
        stateText.value = state || "";
      }
    }

    // Initialize country change handlers
    function initCountryHandlers() {
      ["from", "to"].forEach(prefix => {
        const countrySelect = document.getElementById(`${prefix}Country`);
        countrySelect.addEventListener("change", function() {
          const countryCode = this.value;
          updateStateField(prefix, "", "", countryCode);
        });
      });
    }

    window.onload = function() {
      initAutocomplete();
      initCountryHandlers();
      
      // Set initial state for both address sections
      updateStateField("from", "", "", "CA");
      updateStateField("to", "", "", "CA");
    };

    // Theme toggle functionality
    function toggleTheme() {
      const html = document.documentElement;
      const themeToggle = document.querySelector('.theme-toggle i');
      
      if (html.getAttribute('data-bs-theme') === 'dark') {
        html.setAttribute('data-bs-theme', 'light');
        themeToggle.className = 'bi bi-moon-stars';
      } else {
        html.setAttribute('data-bs-theme', 'dark');
        themeToggle.className = 'bi bi-sun';
      }
    }

    // Load saved theme preference
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-bs-theme', savedTheme);

    // Form submission handler
    document.getElementById('shipmentForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      
      // Validate form before submission
      if (!validateForm()) {
        // Show error message
        const errorMessage = document.createElement('div');
        errorMessage.className = 'alert alert-danger alert-dismissible fade show mb-4';
        errorMessage.innerHTML = `
          <h5 class="alert-heading">Please fix the following errors:</h5>
          <ul class="mb-0">
            ${validationErrors.map(error => `<li>${error}</li>`).join('')}
          </ul>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        // Remove any existing error message
        const existingError = document.querySelector('.alert.alert-danger');
        if (existingError) {
          existingError.remove();
        }

        // Add the new error message at the top of the form
        event.target.insertAdjacentElement('beforebegin', errorMessage);

        // Scroll to the error message
        errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        return;
      }

      // If form is valid, proceed with submission
      try {
        const formData = gatherFormData();
        const response = await fetch('/api/shipments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          throw new Error('Failed to create shipment');
        }

        const result = await response.json();
        showSuccess('Shipment created successfully!');
      } catch (error) {
        showError(error.message);
      }
    });

    let currentRates = [];

    function validateForm() {
      const form = document.getElementById('shipmentForm');
      let isValid = true;
      let validationErrors = [];
      
      // Reset previous validation state
      removeAllValidation();

      // Required fields validation
      const requiredFields = form.querySelectorAll('[required]');
      requiredFields.forEach(field => {
        const fieldLabel = field.previousElementSibling?.textContent?.trim() || 
                          field.getAttribute('placeholder') || 
                          field.id.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        
        if (field.value.trim()) {
          markFieldValid(field, 'Looks good!');
        } else {
          markFieldInvalid(field, 'This field is required');
          validationErrors.push(`${fieldLabel} is required`);
          isValid = false;
        }
      });

      // Validate pickup and delivery times
      const earliestPickup = document.getElementById('earliestPickup');
      const latestPickup = document.getElementById('latestPickup');
      const earliestDelivery = document.getElementById('earliestDelivery');
      const latestDelivery = document.getElementById('latestDelivery');

      if (latestPickup.value && earliestPickup.value) {
        if (latestPickup.value <= earliestPickup.value) {
          markFieldInvalid(latestPickup, 'Latest pickup time must be after earliest pickup time');
          validationErrors.push('Latest pickup time must be after earliest pickup time');
          isValid = false;
        } else {
          markFieldValid(latestPickup, 'Valid pickup window');
          markFieldValid(earliestPickup, 'Valid pickup window');
        }
      }

      if (latestDelivery.value && earliestDelivery.value) {
        if (latestDelivery.value <= earliestDelivery.value) {
          markFieldInvalid(latestDelivery, 'Latest delivery time must be after earliest delivery time');
          validationErrors.push('Latest delivery time must be after earliest delivery time');
          isValid = false;
        } else {
          markFieldValid(latestDelivery, 'Valid delivery window');
          markFieldValid(earliestDelivery, 'Valid delivery window');
        }
      }

      // Validate email formats
      const fromEmail = document.getElementById('fromEmail');
      const toEmail = document.getElementById('toEmail');
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (fromEmail.value) {
        if (emailRegex.test(fromEmail.value)) {
          markFieldValid(fromEmail, 'Valid email format');
        } else {
          markFieldInvalid(fromEmail, 'Invalid email format');
          validationErrors.push('Ship From: Invalid email format');
          isValid = false;
        }
      }

      if (toEmail.value) {
        if (emailRegex.test(toEmail.value)) {
          markFieldValid(toEmail, 'Valid email format');
        } else {
          markFieldInvalid(toEmail, 'Invalid email format');
          validationErrors.push('Ship To: Invalid email format');
          isValid = false;
        }
      }

      // Validate phone numbers
      const fromPhone = document.getElementById('fromPhone');
      const toPhone = document.getElementById('toPhone');
      const phoneRegex = /^\+?[\d\s-()]{10,}$/;

      if (fromPhone.value) {
        if (phoneRegex.test(fromPhone.value)) {
          markFieldValid(fromPhone, 'Valid phone number');
        } else {
          markFieldInvalid(fromPhone, 'Invalid phone number format');
          validationErrors.push('Ship From: Invalid phone number format');
          isValid = false;
        }
      }

      if (toPhone.value) {
        if (phoneRegex.test(toPhone.value)) {
          markFieldValid(toPhone, 'Valid phone number');
        } else {
          markFieldInvalid(toPhone, 'Invalid phone number format');
          validationErrors.push('Ship To: Invalid phone number format');
          isValid = false;
        }
      }

      // Validate packages
      const packages = getPackageItems();
      if (packages.length === 0) {
        validationErrors.push('At least one package is required');
        isValid = false;
      }

      packages.forEach((pkg, index) => {
        const packageId = `package_${index + 1}`;
        const weightField = document.getElementById(`packageWeight_${packageId}`);
        const lengthField = document.getElementById(`packageLength_${packageId}`);
        const widthField = document.getElementById(`packageWidth_${packageId}`);
        const heightField = document.getElementById(`packageHeight_${packageId}`);

        if (pkg.weight <= 0) {
          markFieldInvalid(weightField, 'Weight must be greater than 0');
          validationErrors.push(`Package ${index + 1}: Weight must be greater than 0`);
          isValid = false;
        } else {
          markFieldValid(weightField, 'Valid weight');
        }

        if (pkg.length <= 0) {
          markFieldInvalid(lengthField, 'Length must be greater than 0');
          validationErrors.push(`Package ${index + 1}: Length must be greater than 0`);
          isValid = false;
        } else {
          markFieldValid(lengthField, 'Valid length');
        }

        if (pkg.width <= 0) {
          markFieldInvalid(widthField, 'Width must be greater than 0');
          validationErrors.push(`Package ${index + 1}: Width must be greater than 0`);
          isValid = false;
        } else {
          markFieldValid(widthField, 'Valid width');
        }

        if (pkg.height <= 0) {
          markFieldInvalid(heightField, 'Height must be greater than 0');
          validationErrors.push(`Package ${index + 1}: Height must be greater than 0`);
          isValid = false;
        } else {
          markFieldValid(heightField, 'Valid height');
        }
      });

      if (!isValid) {
        // Create validation summary
        const validationSummary = document.createElement('div');
        validationSummary.className = 'alert alert-danger alert-dismissible fade show mb-4';
        validationSummary.innerHTML = `
          <h5 class="alert-heading">Please fix the following errors:</h5>
          <ul class="mb-0">
            ${validationErrors.map(error => `<li>${error}</li>`).join('')}
          </ul>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        // Remove any existing validation summary
        const existingSummary = document.querySelector('.alert.alert-danger');
        if (existingSummary) {
          existingSummary.remove();
        }

        // Add the new validation summary at the top of the form
        form.insertAdjacentElement('beforebegin', validationSummary);

        // Scroll to the validation summary
        validationSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      return isValid;
    }

    function markFieldValid(field, message) {
      field.classList.remove('is-invalid');
      field.classList.add('is-valid');
      
      // Remove any existing feedback
      const existingFeedback = field.parentElement.querySelectorAll('.valid-feedback, .invalid-feedback');
      existingFeedback.forEach(el => el.remove());
      
      // Add valid feedback
      const feedbackDiv = document.createElement('div');
      feedbackDiv.className = 'valid-feedback';
      feedbackDiv.textContent = message;
      field.parentElement.appendChild(feedbackDiv);
    }

    function markFieldInvalid(field, message) {
      field.classList.remove('is-valid');
      field.classList.add('is-invalid');
      
      // Remove any existing feedback
      const existingFeedback = field.parentElement.querySelectorAll('.valid-feedback, .invalid-feedback');
      existingFeedback.forEach(el => el.remove());
      
      // Add invalid feedback
      const feedbackDiv = document.createElement('div');
      feedbackDiv.className = 'invalid-feedback';
      feedbackDiv.textContent = message;
      field.parentElement.appendChild(feedbackDiv);
    }

    function removeAllValidation() {
      // Remove all validation classes and feedback
      document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
        el.classList.remove('is-valid', 'is-invalid');
      });
      document.querySelectorAll('.valid-feedback, .invalid-feedback').forEach(el => el.remove());
    }

    async function getShippingRates(event) {
      event.preventDefault();
      
      if (!validateForm()) {
        return;
      }

      // Show loading state
      const submitBtn = event.target;
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Calculating...';
      submitBtn.disabled = true;

      try {
        const requestData = {
          bookingReferenceNumber: document.getElementById('bookingReference').value,
          bookingReferenceNumberType: "Shipment",
          shipmentBillType: "DefaultLogisticsPlus",
          shipmentDate: new Date(document.getElementById('shipmentDate').value).toISOString(),
          pickupWindow: {
            earliest: document.getElementById('earliestPickup').value,
            latest: document.getElementById('latestPickup').value
          },
          deliveryWindow: {
            earliest: document.getElementById('earliestDelivery').value,
            latest: document.getElementById('latestDelivery').value
          },
          fromAddress: {
            company: document.getElementById('fromCompany').value,
            street: document.getElementById('fromAddressLine1').value,
            street2: document.getElementById('fromAddressLine2').value || '',
            postalCode: document.getElementById('fromPostal').value,
            city: document.getElementById('fromCity').value,
            state: document.getElementById('fromStateSelect').value || document.getElementById('fromStateText').value,
            country: document.getElementById('fromCountry').value,
            contactName: document.getElementById('fromContactName').value,
            contactPhone: document.getElementById('fromPhone').value,
            contactEmail: document.getElementById('fromEmail').value,
            contactFax: document.getElementById('fromFax').value || '',
            specialInstructions: document.getElementById('fromInstructions').value || ''
          },
          toAddress: {
            company: document.getElementById('toCompany').value,
            street: document.getElementById('toAddressLine1').value,
            street2: document.getElementById('toAddressLine2').value || '',
            postalCode: document.getElementById('toPostal').value,
            city: document.getElementById('toCity').value,
            state: document.getElementById('toStateSelect').value || document.getElementById('toStateText').value,
            country: document.getElementById('toCountry').value,
            contactName: document.getElementById('toContactName').value,
            contactPhone: document.getElementById('toPhone').value,
            contactEmail: document.getElementById('toEmail').value,
            contactFax: document.getElementById('toFax').value || '',
            specialInstructions: document.getElementById('toInstructions').value || ''
          },
          items: getPackageItems()
        };

        const response = await fetch('https://getshippingrates-xedyh5vw7a-uc.a.run.app/rates', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });

        const result = await response.json();
        if (result.success) {
          displayRates(result.data.availableRates);
        } else {
          throw new Error(result.error.message);
        }
      } catch (error) {
        console.error('Error:', error);
        showError('Error calculating rates: ' + error.message);
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    function displayRates(rates) {
      currentRates = rates;
      const ratesSection = document.getElementById('ratesSection');
      ratesSection.style.display = 'block';
      sortRates();
      ratesSection.scrollIntoView({ behavior: 'smooth' });
    }

    function sortRates() {
      const sortBy = document.getElementById('rateSortBy').value;
      const guaranteedOnly = document.getElementById('guaranteedOnly').checked;
      
      let sortedRates = [...currentRates];
      
      switch(sortBy) {
        case 'price':
          sortedRates.sort((a, b) => a.totalCharges - b.totalCharges);
          break;
        case 'time':
          sortedRates.sort((a, b) => a.transitTime - b.transitTime);
          break;
        case 'carrier':
          sortedRates.sort((a, b) => a.carrierName.localeCompare(b.carrierName));
          break;
      }

      if (guaranteedOnly) {
        sortedRates = sortedRates.filter(rate => rate.guarOptions.length > 0);
      }

      renderRates(sortedRates);
    }

    function filterRates() {
      sortRates();
    }

    function renderRates(rates) {
      const ratesGrid = document.getElementById('ratesGrid');
      ratesGrid.innerHTML = '';

      if (rates.length === 0) {
        ratesGrid.innerHTML = `
          <div class="col-12 text-center py-5">
            <h5 class="text-muted">No rates match your criteria</h5>
          </div>
        `;
        return;
      }

      rates.forEach(rate => {
        const rateCard = document.createElement('div');
        rateCard.className = 'col-md-4';
        rateCard.innerHTML = `
          <div class="card h-100 rate-card ${rate.carrierName.toLowerCase().replace(/\s+/g, '-')}">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">${rate.carrierName}</h5>
              ${rate.guarOptions.length > 0 ? '<span class="badge bg-warning">Guaranteed Available</span>' : ''}
            </div>
            <div class="card-body">
              <div class="mb-3">
                <h6 class="text-primary mb-2">Transit Information</h6>
                <p class="mb-1"><strong>Transit Time:</strong> ${rate.transitTime} days</p>
                <p class="mb-1"><strong>Delivery By:</strong> ${new Date(rate.estimatedDeliveryDate).toLocaleDateString()}</p>
                <p class="mb-0"><strong>Service:</strong> ${rate.serviceMode}</p>
              </div>
              <div class="mb-3">
                <h6 class="text-primary mb-2">Charges Breakdown</h6>
                <p class="mb-1"><strong>Freight:</strong> $${rate.freightCharges.toFixed(2)}</p>
                <p class="mb-1"><strong>Fuel:</strong> $${rate.fuelCharges.toFixed(2)}</p>
                <p class="mb-1"><strong>Accessorial:</strong> $${rate.accessorialCharges.toFixed(2)}</p>
                <p class="mb-1"><strong>Service:</strong> $${rate.serviceCharges.toFixed(2)}</p>
                <h5 class="mt-3 text-primary">Total: $${rate.totalCharges.toFixed(2)}</h5>
              </div>
              ${rate.guarOptions.length > 0 ? `
                <div class="mt-3">
                  <h6 class="text-primary mb-2">Guarantee Options</h6>
                  ${rate.guarOptions.map(option => `
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="guarOption_${rate.carrierScac}" 
                             id="${option.billingCode}_${rate.carrierScac}" value="${option.billingCode}">
                      <label class="form-check-label" for="${option.billingCode}_${rate.carrierScac}">
                        ${option.description} (+$${option.amountDue.toFixed(2)})
                      </label>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
            <div class="card-footer">
              <button class="btn btn-primary w-100" onclick="selectRate('${rate.carrierKey}', '${rate.quoteId}')">
                Select Rate
              </button>
            </div>
          </div>
        `;
        ratesGrid.appendChild(rateCard);
      });
    }

    function selectRate(carrierKey, quoteId) {
      // TODO: Implement rate selection and booking
      console.log('Selected rate:', { carrierKey, quoteId });
    }

    function getPackageItems() {
      const packages = document.querySelectorAll('.package-card');
      return Array.from(packages).map(pkg => ({
        name: pkg.querySelector('[id^="packageDescription"]').value,
        quantity: parseInt(pkg.querySelector('[id^="packageQuantity"]').value),
        weight: parseFloat(pkg.querySelector('[id^="packageWeight"]').value),
        value: parseFloat(pkg.querySelector('[id^="packageValue"]').value || 0),
        length: parseInt(pkg.querySelector('[id^="packageLength"]').value),
        width: parseInt(pkg.querySelector('[id^="packageWidth"]').value),
        height: parseInt(pkg.querySelector('[id^="packageHeight"]').value),
        freightClass: pkg.querySelector('[id^="packageFreightClass"]').value,
        stackable: pkg.querySelector('[id^="packageStackable"]').checked
      }));
    }
  </script>
</body>
</html>
